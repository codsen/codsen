/**
 * string-fix-broken-named-entities
 * Finds and fixes common and not so common broken named HTML entities, returns ranges array of fixes
 * Version: 4.0.1
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/string-fix-broken-named-entities/
 */

import e from"leven";import{entStartsWith as t,decode as r,uncertain as n,entEndsWith as a,maxLength as o,allNamedEntitiesSetOnlyCaseInsensitive as l,allNamedEntitiesSetOnly as i,brokenNamedEntities as m}from"all-named-html-entities";import{right as s,rightSeq as c,left as d,leftSeq as u}from"string-left-right";function g(e){return e&&"object"==typeof e&&!Array.isArray(e)}function h(e){return f(e)&&1===e.length&&(e.charCodeAt(0)>96&&e.charCodeAt(0)<123||e.charCodeAt(0)>47&&e.charCodeAt(0)<58||e.charCodeAt(0)>64&&e.charCodeAt(0)<91||35===e.charCodeAt(0))}function p(e){return f(e)&&e.charCodeAt(0)>47&&e.charCodeAt(0)<58}function f(e){return"string"==typeof e}function y(e){return"string"==typeof e&&(e.charCodeAt(0)>96&&e.charCodeAt(0)<123||e.charCodeAt(0)>64&&e.charCodeAt(0)<91)}function C(e,t,r){let n=0,a=0,o=0,l=0,i=0,m="",s="";for(let c=t;c<r;c++)e[c].trim().length?s+=e[c]:i+=1,y(e[c])?n+=1:p(e[c])?(a+=1,m+=String(e[c])):"#"===e[c]?l+=1:o+=1;let c=!1;return!n&&a>o?c="deci":(a||n)&&("#"===s[0]&&"x"===s[1].toLowerCase()&&(p(s[2])||y(s[2]))||"x"===s[0].toLowerCase()&&a&&!o)&&(c="hexi"),{probablyNumeric:c,lettersCount:n,numbersCount:a,numbersValue:m,hashesCount:l,othersCount:o,charTrimmed:s,whitespaceCount:i}}function b(e){return Array.isArray(e)&&e.length?1===e.length?e[0]:e.reduce(((e,t)=>t.tempEnt.length>e.tempEnt.length?t:e)):e}function N(e,t){if(2!==arguments.length)throw new Error("removeGappedFromMixedCases(): wrong amount of inputs!");let r;return Array.isArray(t)&&t.length&&(r=Array.from(t),r.length>1&&r.some((t=>";"===e[s(e,t.tempRes.rightmostChar)]))&&r.some((t=>";"!==e[s(e,t.tempRes.rightmostChar)]))&&(r=r.filter((t=>";"===e[s(e,t.tempRes.rightmostChar)]))),!r.every((e=>!(e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))&&!r.every((e=>e&&e.tempRes&&e.tempRes.gaps&&Array.isArray(e.tempRes.gaps)&&e.tempRes.gaps.length)))?b(r.filter((e=>!e.tempRes.gaps||!Array.isArray(e.tempRes.gaps)||!e.tempRes.gaps.length))):b(t)}const T="4.0.1";function $(y,b){if("string"!=typeof y)throw new Error(`string-fix-broken-named-entities: [THROW_ID_01] the first input argument must be string! It was given as:\n${JSON.stringify(y,null,4)} (${typeof y}-type)`);const T={decode:!1,cb:({rangeFrom:e,rangeTo:t,rangeValEncoded:r,rangeValDecoded:n})=>n||r?[e,t,g(b)&&b.decode?n:r]:[e,t],progressFn:null,entityCatcherCb:null};if(b&&!g(b))throw new Error(`string-fix-broken-named-entities: [THROW_ID_02] the second input argument must be a plain object! I was given as:\n${JSON.stringify(b,null,4)} (${typeof b}-type)`);const $={...T,...b};if($.cb&&"function"!=typeof $.cb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_03] opts.cb must be a function (or falsey)! Currently it's: ${typeof $.cb}, equal to: ${JSON.stringify($.cb,null,4)}`);if($.entityCatcherCb&&"function"!=typeof $.entityCatcherCb)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_04] opts.entityCatcherCb must be a function (or falsey)! Currently it's: ${typeof $.entityCatcherCb}, equal to: ${JSON.stringify($.entityCatcherCb,null,4)}`);if($.progressFn&&"function"!=typeof $.progressFn)throw new TypeError(`string-fix-broken-named-entities: [THROW_ID_05] opts.progressFn must be a function (or falsey)! Currently it's: ${typeof $.progressFn}, equal to: ${JSON.stringify($.progressFn,null,4)}`);const w=[];let V,A;const E=y.length+1;let F=0,O=null,R=null,D=null;for(let g=0;g<E;g++){if($.progressFn&&(V=Math.floor(F/E*100),V!==A&&(A=V,$.progressFn(V))),O){if(!("number"==typeof O&&g>=O)){F+=1;continue}O=null}if(null!==R&&g-R>50&&(R=null),null!==R&&(!y[g]||y[g].trim().length&&!h(y[g]))){if(g>R+1){const h=y.slice(R,g),p=d(y,R),b=p?d(y,p):"";if("&"!==y[p]||y[g]&&";"===y[g]){if("&"!==y[p]&&"&"!==y[b]&&";"===y[g]){const e=d(y,g),t=d(y,e);if(null!==t&&Object.prototype.hasOwnProperty.call(a,y[e])&&Object.prototype.hasOwnProperty.call(a[y[e]],y[t])){let o,l="",i=a[y[e]][y[t]].reduce(((e,t)=>(o=u(y,g,...t.split("")),!o||"block"===t&&":"===y[d(y,R)]?e:e.concat([{tempEnt:t,tempRes:o}]))),[]);if(i=N(y,i),i&&({tempEnt:l,tempRes:o}=i),l&&(!Object.keys(n).includes(l)||!0===n[l].addAmpIfSemiPresent||n[l].addAmpIfSemiPresent&&(!o.leftmostChar||f(y[o.leftmostChar-1])&&!y[o.leftmostChar-1].trim().length))){const e=r(`&${l};`);w.push({ruleName:`bad-named-html-entity-malformed-${l}`,entityName:l,rangeFrom:o.leftmostChar,rangeTo:g+1,rangeValEncoded:`&${l};`,rangeValDecoded:e})}}else null!==D&&(w.push({ruleName:"bad-malformed-numeric-character-entity",entityName:null,rangeFrom:D,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null}),D=null)}else if(("&"===y[p]||";"===y[p]&&"&"===y[b])&&";"===y[g]){if(y.slice(p+1,g).trim().length>1){const t=C(y,p+1,g);if(t.probablyNumeric){if(t.probablyNumeric&&"#"===t.charTrimmed[0]&&!t.whitespaceCount&&(!t.lettersCount&&t.numbersCount>0&&!t.othersCount||(t.numbersCount||t.lettersCount)&&"x"===t.charTrimmed[1]&&!t.othersCount)){const e=String.fromCharCode(parseInt(t.charTrimmed.slice("deci"===t.probablyNumeric?1:2),"deci"===t.probablyNumeric?10:16));"deci"===t.probablyNumeric&&parseInt(t.numbersValue,10)>918015?w.push({ruleName:"bad-malformed-numeric-character-entity",entityName:null,rangeFrom:p||0,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null}):$.decode&&w.push({ruleName:"encoded-numeric-html-entity-reference",entityName:t.charTrimmed,rangeFrom:p||0,rangeTo:g+1,rangeValEncoded:`&${t.charTrimmed};`,rangeValDecoded:e})}else w.push({ruleName:"bad-malformed-numeric-character-entity",entityName:null,rangeFrom:p||0,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null});$.entityCatcherCb&&$.entityCatcherCb(p,g+1)}else{const a=Array.from(h).filter((e=>e.trim().length)).join("");if(a.length<=o&&l.has(a.toLowerCase())){if(i.has(a))if(g-p-1!==a.length||"&"!==y[p]){const e="&"===y[p]?p:b;if(Object.keys(n).includes(a)&&!y[e+1].trim().length){R=null;continue}w.push({ruleName:`bad-named-html-entity-malformed-${a}`,entityName:a,rangeFrom:e,rangeTo:g+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)})}else $.decode?w.push({ruleName:`encoded-html-entity-${a}`,entityName:a,rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${a};`,rangeValDecoded:r(`&${a};`)}):$.entityCatcherCb&&$.entityCatcherCb(p,g+1);else{const e=[...i].filter((e=>e.toLowerCase()===a.toLowerCase()));w.push(1===e.length?{ruleName:`bad-named-html-entity-malformed-${e[0]}`,entityName:e[0],rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${e[0]};`,rangeValDecoded:r(`&${e[0]};`)}:{ruleName:"bad-named-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null})}R=null;continue}R&&s(y,R);let c,d="";if(Object.prototype.hasOwnProperty.call(m,t.charTrimmed.toLowerCase())){d=t.charTrimmed;const e=r(`&${m[t.charTrimmed.toLowerCase()]};`);w.push({ruleName:`bad-named-html-entity-malformed-${m[t.charTrimmed.toLowerCase()]}`,entityName:m[t.charTrimmed.toLowerCase()],rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${m[t.charTrimmed.toLowerCase()]};`,rangeValDecoded:e})}else h.length<o+2&&((c=[...i].filter((t=>1===e(t,h))))&&c.length||(c=[...i].filter((t=>2===e(t,h)&&h.length>3)))&&c.length)&&1===c.length&&([d]=c,w.push({ruleName:`bad-named-html-entity-malformed-${d}`,entityName:d,rangeFrom:p,rangeTo:g+1,rangeValEncoded:`&${d};`,rangeValDecoded:r(`&${d};`)}));d||w.push({ruleName:"bad-named-html-entity-unrecognised",entityName:null,rangeFrom:p,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null})}}}else if("&"===y[b]&&";"===y[g]&&g-b<o){const e=C(y,b+1,g);w.push({ruleName:""+(e.probablyNumeric?"bad-malformed-numeric-character-entity":"bad-named-html-entity-unrecognised"),entityName:null,rangeFrom:b,rangeTo:g+1,rangeValEncoded:null,rangeValDecoded:null})}}else{const e=R,a=R?s(y,R):null;if(Object.prototype.hasOwnProperty.call(t,y[e])&&Object.prototype.hasOwnProperty.call(t[y[e]],y[a])){let o,l="",i=t[y[e]][y[a]].reduce(((e,t)=>(o=c(y,R-1,...t.split("")),o?e.concat([{tempEnt:t,tempRes:o}]):e)),[]);if(i=N(y,i),i&&({tempEnt:l,tempRes:o}=i),l&&(!Object.keys(n).includes(l)||!y[o.rightmostChar+1]||["&"].includes(y[o.rightmostChar+1])||(!0===n[l].addSemiIfAmpPresent||n[l].addSemiIfAmpPresent&&(!y[o.rightmostChar+1]||!y[o.rightmostChar+1].trim().length))&&"&"===y[o.leftmostChar-1])){const e=r(`&${l};`);w.push({ruleName:`bad-named-html-entity-malformed-${l}`,entityName:l,rangeFrom:p||0,rangeTo:o.rightmostChar+1,rangeValEncoded:`&${l};`,rangeValDecoded:e})}}}}R=null}if(null===R&&h(y[g])&&y[g+1]&&(R=g),"a"===y[g]){const e=c(y,g,"m","p",";");if(e){let n=e.rightmostChar+1;const a=c(y,e.rightmostChar,"a","m","p",";");if(a){let e;n=a.rightmostChar+1;do{e=c(y,n-1,"a","m","p",";"),e&&(n=e.rightmostChar+1)}while(e)}const o=s(y,n-1),l=o?s(y,o):null;let i="";if(l&&Object.prototype.hasOwnProperty.call(t,y[o])&&Object.prototype.hasOwnProperty.call(t[y[o]],y[l])&&t[y[o]][y[l]].some((e=>{if(c(y,n-1,...e.split("")))return i=e,!0}))){O=o+i.length+1;const e=d(y,g);if("&"===y[e])w.push({ruleName:"bad-named-html-entity-multiple-encoding",entityName:i,rangeFrom:e||0,rangeTo:O,rangeValEncoded:`&${i};`,rangeValDecoded:r(`&${i};`)});else if(e){const e=g,t="";"function"==typeof $.cb&&w.push({ruleName:"bad-named-html-entity-multiple-encoding",entityName:i,rangeFrom:e,rangeTo:O,rangeValEncoded:`${t}&${i};`,rangeValDecoded:`${t}${r(`&${i};`)}`})}}}}"#"!==y[g]||!s(y,g)||"x"!==y[s(y,g)].toLowerCase()||y[g-1]&&d(y,g)&&"&"===y[d(y,g)]||p(y[s(y,s(y,g))])&&(D=g),F+=1}if(!w.length)return[];return w.filter(((e,t)=>w.every(((r,n)=>t===n||!(e.rangeFrom>=r.rangeFrom&&e.rangeTo<r.rangeTo))))).map($.cb)}export{$ as fixEnt,T as version};
