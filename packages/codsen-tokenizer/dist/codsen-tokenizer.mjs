/**
 * codsen-tokenizer
 * HTML and CSS lexer aimed at code with fatal errors, accepts mixed coding languages
 * Version: 5.1.2
 * Author: Roy Revelt, Codsen Ltd
 * License: MIT
 * Homepage: https://codsen.com/os/codsen-tokenizer/
 */

import{matchRight as t,matchLeft as e,matchRightIncl as a,matchLeftIncl as r}from"string-match-left-right";import l from"lodash.clonedeep";import{right as i,left as n}from"string-left-right";import{isAttrClosing as s}from"is-html-attribute-closing";import{allHtmlAttribs as u}from"html-all-known-attributes";import{isAttrNameChar as o}from"is-char-suitable-for-html-attr-name";import{isOpening as p}from"is-html-tag-opening";const d=new Set(["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","bgsound","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","command","content","data","datalist","dd","del","details","dfn","dialog","dir","div","dl","dt","element","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","image","img","input","ins","isindex","kbd","keygen","label","legend","li","link","listing","main","map","mark","marquee","menu","menuitem","meta","meter","multicol","nav","nextid","nobr","noembed","noframes","noscript","object","ol","optgroup","option","output","p","param","picture","plaintext","pre","progress","q","rb","rp","rt","rtc","ruby","s","samp","script","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr","xmp"]),g="{}%-$_()*|#",c="{}|#",b="%()$_*#",h="({",m="})",y=[")|(","|(",")(","()","}{","{}","%)","*)","||","--"],A=".,;!?";function f(t){return!(!t||!(t.charCodeAt(0)>64&&t.charCodeAt(0)<91||t.charCodeAt(0)>96&&t.charCodeAt(0)<123))}function V(t){let e="";for(let a=0,r=t.length;a<r;a++)e="["===t[a]?`]${e}`:"]"===t[a]?`[${e}`:"{"===t[a]?`}${e}`:"}"===t[a]?`{${e}`:"("===t[a]?`)${e}`:")"===t[a]?`(${e}`:"<"===t[a]?`>${e}`:">"===t[a]?`<${e}`:"“"===t[a]?`”${e}`:"”"===t[a]?`“${e}`:`${t[a]}${e}`;return e}function S(t){return d.has(t.toLowerCase())||["doctype","cdata","xml"].includes(t.toLowerCase())}function v(t,e,a,r){for(let l=e,i=t.length;l<i;l++){if(t.startsWith(a,l))return!0;if(t.startsWith(r,l))return!1}return!1}function E(t){return t&&"object"==typeof t&&!Array.isArray(t)}const C=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"],k=new Set(["a","abbr","acronym","audio","b","bdi","bdo","big","br","button","canvas","cite","code","data","datalist","del","dfn","em","embed","i","iframe","img","input","ins","kbd","label","map","mark","meter","noscript","object","output","picture","progress","q","ruby","s","samp","script","select","slot","small","span","strong","sub","sup","svg","template","textarea","time","u","tt","var","video","wbr"]),N=["{","}",","],x="'\"“”",L=/[\w-]/;function O(t){if(t&&t.length)for(let e=t.length;e--;)if("esp"===t[e].type)return e}function w(t,e,a){let r=t[e];const l=t.length,i=a[O(a)];for(let n=e+1;n<l&&(!h.includes(t[n])||!m.includes(t[n-1]))&&!(r.length>1&&(r.includes("<")||r.includes("{")||r.includes("[")||r.includes("("))&&"("===t[n])&&(g.includes(t[n])||i&&i.guessedClosingLump.includes(t[n])||"<"===t[e]&&"/"===t[n]||">"===t[n]&&"--"===r&&Array.isArray(a)&&a.length&&"esp"===a[a.length-1].type&&"<"===a[a.length-1].openingLump[0]&&"-"===a[a.length-1].openingLump[2]&&"-"===a[a.length-1].openingLump[3]||!i&&n>e&&"!=@".includes(t[n]));n++)r+=t[n];if(r&&Array.isArray(a)&&a.length&&"esp"===a[a.length-1].type&&a[a.length-1].guessedClosingLump&&r.length>a[a.length-1].guessedClosingLump.length){if(r.endsWith(a[a.length-1].openingLump))return r.slice(0,r.length-a[a.length-1].openingLump.length);let t=new Set(a[a.length-1].guessedClosingLump),e=0;for(let a=0,l=r.length;a<l;a++){if(!t.has(r[a])&&e>1)return r.slice(0,a);t.has(r[a])&&(e+=1,t=new Set([...t].filter((t=>t!==r[a]))))}}return r}function M(a,r,l,i){return!(("<"!==a[r]||!t(a,r,["!--"],{maxMismatches:1,firstMustMatch:!0,trimBeforeMatching:!0})&&!t(a,r,["![endif]"],{i:!0,maxMismatches:2,trimBeforeMatching:!0})||t(a,r,["![cdata","<"],{i:!0,maxMismatches:1,trimBeforeMatching:!0})||"comment"===l.type&&"not"===l.kind)&&("-"!==a[r]||!t(a,r,["->"],{trimBeforeMatching:!0})||"comment"===l.type&&(l.closing||"not"===l.kind)||e(a,r,"<",{trimBeforeMatching:!0,trimCharsBeforeMatching:["-","!"]})||Array.isArray(i)&&i.length&&"esp"===i[i.length-1].type&&"<"===i[i.length-1].openingLump[0]&&"-"===i[i.length-1].openingLump[2]&&"-"===i[i.length-1].openingLump[3]))}function Q(t,e,a,r,l){return l&&("/"===t[e]&&"*"===t[e+1]||"*"===t[e]&&"/"===t[e+1])}function $(t,e,a=!1){if(!e.length)return;const r=a?e[0]:e[e.length-1];return"esp"===r.type&&(t.includes(r.guessedClosingLump)||Array.from(t).every((t=>r.guessedClosingLump.includes(t)))||r.guessedClosingLump&&r.guessedClosingLump.length>2&&r.guessedClosingLump[r.guessedClosingLump.length-1]===t[t.length-1]&&r.guessedClosingLump[r.guessedClosingLump.length-2]===t[t.length-2])?t.length:void 0}const F="\\";function q(e,a,r,l,s){return!(!e[a]||!e[a].trim().length||l.length&&"text"!==r.type||r.kind&&["doctype","xml"].includes(r.kind)||s&&"<"!==e[a]||!("<"===e[a]&&(p(e,a,{allowCustomTagNames:!0})||">"===e[i(e,a)]||t(e,a,["doctype","xml","cdata"],{i:!0,trimBeforeMatching:!0,trimCharsBeforeMatching:["?","!","["," ","-"]}))||f(e[a])&&(!e[a-1]||!f(e[a-1])&&!["<","/","!",F].includes(e[n(e,a)]))&&p(e,a,{allowCustomTagNames:!1,skipOpeningBracket:!0}))||!("esp"!==r.type||r.tail&&r.tail.includes(e[a])))}function B(t,e,a,r,l){return!!(g.includes(t[e])&&t[e+1]&&g.includes(t[e+1])&&!(b.includes(t[e])&&b.includes(t[e+1]))&&(t[e]!==t[e+1]||c.includes(t[e]))&&"rule"!==a.type&&"at"!==a.type&&!("-"===t[e]&&"-{(".includes(t[e+1]))&&!("})".includes(t[e])&&"-".includes(t[e+1]))&&!("%"===t[e]&&"%"===t[e+1]&&"0123456789".includes(t[e-1])&&(!t[e+2]||A.includes(t[e+2])||!t[e+2].trim().length))&&!(l&&("{}".includes(t[e])||"{}".includes(t[i(t,e)])))||"<"===t[e]&&("/"===t[e+1]&&g.includes(t[e+2])||g.includes(t[e+1])&&!["-"].includes(t[e+1]))||"<"===t[e]&&("%"===t[e+1]||t.startsWith("jsp:",e+1)||t.startsWith("cms:",e+1)||t.startsWith("c:",e+1))||t.startsWith("${jspProp",e)||">})".includes(t[e])&&Array.isArray(r)&&r.length&&"esp"===r[r.length-1].type&&r[r.length-1].openingLump.includes(V(t[e]))&&(">"!==t[e]||!v(t,e+1,">","<"))||"-"===t[e]&&"-"===t[e+1]&&">"===t[e+2]&&Array.isArray(r)&&r.length&&"esp"===r[r.length-1].type&&"<"===r[r.length-1].openingLump[0]&&"-"===r[r.length-1].openingLump[2]&&"-"===r[r.length-1].openingLump[3])}const W="5.1.2",P=/^\s*!?\s*[a-zA-Z]+(?:[\s;}<>'"]|$)/gm,T={tagCb:null,tagCbLookahead:0,charCb:null,charCbLookahead:0,reportProgressFunc:null,reportProgressFuncFrom:0,reportProgressFuncTo:100};function R(p,d){const b=Date.now();if("string"!=typeof p)throw void 0===p?new Error("codsen-tokenizer: [THROW_ID_01] the first input argument is completely missing! It should be given as string."):new Error(`codsen-tokenizer: [THROW_ID_02] the first input argument must be string! It was given as "${typeof p}", equal to:\n${JSON.stringify(p,null,4)}`);if(d&&!E(d))throw new Error(`codsen-tokenizer: [THROW_ID_03] the second input argument, an options object, should be a plain object but it was given as type ${typeof d}, equal to ${JSON.stringify(d,null,4)}`);if(d&&E(d)&&d.tagCb&&"function"!=typeof d.tagCb)throw new Error(`codsen-tokenizer: [THROW_ID_04] the opts.tagCb, callback function, should be a function but it was given as type ${typeof d.tagCb}, equal to ${JSON.stringify(d.tagCb,null,4)}`);if(d&&E(d)&&d.charCb&&"function"!=typeof d.charCb)throw new Error(`codsen-tokenizer: [THROW_ID_05] the opts.charCb, callback function, should be a function but it was given as type ${typeof d.charCb}, equal to ${JSON.stringify(d.charCb,null,4)}`);if(d&&E(d)&&d.reportProgressFunc&&"function"!=typeof d.reportProgressFunc)throw new Error(`codsen-tokenizer: [THROW_ID_06] the opts.reportProgressFunc, callback function, should be a function but it was given as type ${typeof d.reportProgressFunc}, equal to ${JSON.stringify(d.reportProgressFunc,null,4)}`);const h={...T,...d};let m=0,A=0;const F=p.length,W=Math.floor(F/2);let R=0,_=!1,H=!1;const D=[],I=[];let z={};function j(){z={type:null,start:null,end:null,value:null},Z()}const J={attribName:"",attribNameRecognised:!1,attribNameStartsAt:null,attribNameEndsAt:null,attribOpeningQuoteAt:null,attribClosingQuoteAt:null,attribValueRaw:null,attribValue:[],attribValueStartsAt:null,attribValueEndsAt:null,attribStarts:null,attribEnds:null,attribLeft:null};let U={...J};function Z(){U=l(J)}function G(t){U.attribValue.length&&U.attribValue[~-U.attribValue.length].start&&!U.attribValue[~-U.attribValue.length].end&&(U.attribValue[~-U.attribValue.length].end=t.start,U.attribValue[~-U.attribValue.length].value=p.slice(U.attribValue[~-U.attribValue.length].start,t.start)),U.attribValue.push(t)}const K={start:null,end:null,value:null,property:null,propertyStarts:null,propertyEnds:null,importantStarts:null,importantEnds:null,important:null,colon:null,valueStarts:null,valueEnds:null,semi:null};let X,Y,tt,et={...K};function at(){et={...K}}function rt(t){U&&"style"===U.attribName?U.attribValue.push({...t}):z&&Array.isArray(z.properties)&&z.properties.push({...t})}j();let lt=null;const it=[];function nt(t){return!(!Array.isArray(it)||!it.length||it[~-it.length].type!==t)}function st(t){const e=(i(p,t)||t)+1;G({type:"comment",start:t,end:e,value:p.slice(t,e),closing:!0,kind:"block",language:"css"}),R=e,nt("block")&&it.pop()}function ut(t,e,a){const r=t.shift(),i=[];for(let e=0;e<a&&t[e];e++)i.push(l(t[e]));"function"==typeof e&&e(r,i)}function ot(t){h.tagCb&&(D.push(t),D.length>h.tagCbLookahead&&ut(D,h.tagCb,h.tagCbLookahead))}function pt(t,e){if(!["text","esp"].includes(t.type)&&null!==t.start&&t.start<e&&(p[~-e]&&!p[~-e].trim()||"<"===p[e]))if(t.end=null!==n(p,e)?n(p,e)+1:e,t.value=p.slice(t.start,t.end),"tag"!==t.type||"/>".includes(p[~-t.end]))ot(t),j(),p[~-e]&&!p[~-e].trim()&&gt("text",n(p,e)+1);else{let a=t.tagNameEndsAt||e;if(Array.isArray(t.attribs)&&t.attribs.length)for(let e=0,r=t.attribs.length;e<r;e++){if(!t.attribs[e].attribNameRecognised||!t.attribs[e].attribEnds){t.attribs=0===e?[]:t.attribs.splice(0,e);break}a=t.attribs[e].attribEnds,p[a+1]&&!p[a].trim()&&p[a+1].trim()&&(a+=1)}t.end=a,t.value=p.slice(t.start,t.end),t.tagNameEndsAt||(t.tagNameEndsAt=a),t.tagNameStartsAt&&t.tagNameEndsAt&&!t.tagName&&(t.tagName=p.slice(t.tagNameStartsAt,a),t.recognised=S(t.tagName)),ot(t),gt("text",a)}null!==z.start&&(null===z.end&&z.start!==e&&(z.end=e,z.value=p.slice(z.start,z.end)),null!==z.start&&z.end&&(nt("at")?it[~-it.length].token.rules.push(z):ot(z)),j())}function dt(t,e=null){return"tag"===t?{type:t,start:e,end:null,value:null,tagNameStartsAt:null,tagNameEndsAt:null,tagName:null,recognised:null,closing:!1,void:!1,pureHTML:!0,kind:null,attribs:[]}:"comment"===t?{type:t,start:e,end:null,value:null,closing:!1,kind:"simple",language:"html"}:"rule"===t?{type:t,start:e,end:null,value:null,left:null,nested:!1,openingCurlyAt:null,closingCurlyAt:null,selectorsStart:null,selectorsEnd:null,selectors:[],properties:[]}:"at"===t?{type:t,start:e,end:null,value:null,left:null,nested:!1,openingCurlyAt:null,closingCurlyAt:null,identifier:null,identifierStartsAt:null,identifierEndsAt:null,query:null,queryStartsAt:null,queryEndsAt:null,rules:[]}:"esp"===t?{type:t,start:e,end:null,value:null,head:null,headStartsAt:null,headEndsAt:null,tail:null,tailStartsAt:null,tailEndsAt:null}:{type:"text",start:e,end:null,value:null}}function gt(t,e){Z(),z=dt(t,e)}function ct(t){at(),et.propertyStarts=t,et.start=t}function bt(t){return!"'\"".includes(p[t])||!(U.attribOpeningQuoteAt||U.attribValueStartsAt)||s(p,U.attribOpeningQuoteAt||U.attribValueStartsAt,t)}for(let d=0;d<=F;d++){!R&&p[d]&&h.reportProgressFunc&&(F>1e3&&F<2e3?d===W&&h.reportProgressFunc(Math.floor((h.reportProgressFuncTo-h.reportProgressFuncFrom)/2)):F>=2e3&&(m=h.reportProgressFuncFrom+Math.floor(d/F*(h.reportProgressFuncTo-h.reportProgressFuncFrom)),m!==A&&(A=m,h.reportProgressFunc(m))));const b=n(p,d),T=i(p,d);if(_&&z.type&&!["rule","at","text","comment"].includes(z.type)&&(_=!1),R&&d>=R&&(R=0),f(p[d])&&f(p[~-d])&&f(p[d+1]))continue;if(" \t\r\n".includes(p[d])&&p[d]===p[~-d]&&p[d]===p[d+1])continue;if(!R&&nt("at")&&E(it[~-it.length].token)&&it[~-it.length].token.openingCurlyAt&&!it[~-it.length].token.closingCurlyAt)if("}"===p[d]){if(!z.type||"text"===z.type||"rule"===z.type&&null===z.openingCurlyAt){"rule"===z.type&&(z.end=b+1,z.value=p.slice(z.start,z.end),ot(z),nt("at")&&it[~-it.length].token.rules.push(z),j(),null!==b&&b<~-d&&gt("text",b+1)),pt(z,d);const t=it.pop();z=t.token,z.closingCurlyAt=d,z.end=d+1,z.value=p.slice(z.start,z.end),ot(z),nt("at")&&it[~-it.length].token.rules.push(z),j(),R=d+1}}else"text"===z.type&&p[d]&&p[d].trim()&&(z.end=d,z.value=p.slice(z.start,z.end),nt("at")?it[~-it.length].token.rules.push(z):ot(z),j());z.end&&z.end===d&&("style"!==z.tagName||z.closing||(_=!0),tt?(U=tt,U.attribValue.push(z),z=l(Y),tt=void 0,Y=void 0):(pt(z,d),it.length=0)),R||(["tag","rule","at"].includes(z.type)&&"cdata"!==z.kind?!p[d]||!x.includes(p[d])&&!"()".includes(p[d])||x.includes(p[b])&&p[b]===p[T]||!bt(d)||(nt("simple")&&it[~-it.length].value===V(p[d])?it.pop():it.push({type:"simple",value:p[d],position:d})):"comment"===z.type&&["only","not"].includes(z.kind)?["[","]"].includes(p[d])&&(nt("simple")&&it[~-it.length].value===V(p[d])?it.pop():it.push({type:"simple",value:p[d],position:d})):"esp"!==z.type||!"'\"`()".includes(p[d])||['"',"'","`"].includes(p[b])&&p[b]===p[T]||(nt("simple")&&it[~-it.length].value===V(p[d])?(it.pop(),R=d+1):"]})>".includes(p[d])||it.push({type:"simple",value:p[d],position:d}))),!R&&"at"===z.type&&null!=z.start&&d>=z.start&&!z.identifierStartsAt&&p[d]&&p[d].trim()&&"@"!==p[d]&&(z.identifierStartsAt=d),!R&&"at"===z.type&&z.queryStartsAt&&!z.queryEndsAt&&"{;".includes(p[d])&&(z.queryEndsAt="{"===p[d]?p[~-d]&&p[~-d].trim()?d:null!==b?b+1:d:n(p,d+1)||0,z.queryStartsAt&&z.queryEndsAt&&(z.query=p.slice(z.queryStartsAt,z.queryEndsAt)),z.end=";"===p[d]?d+1:d,z.value=p.slice(z.start,z.end),";"===p[d]?ot(z):(z.openingCurlyAt=d,it.push({type:"at",token:z})),j(),R=d+1),!R&&"at"===z.type&&z.identifier&&p[d]&&p[d].trim()&&!z.queryStartsAt&&(z.queryStartsAt=d),!R&&z&&"at"===z.type&&z.identifierStartsAt&&d>=z.start&&p[d]&&(!p[d].trim()||"()".includes(p[d]))&&!z.identifierEndsAt&&(z.identifierEndsAt=d,z.identifier=p.slice(z.identifierStartsAt,d)),"rule"===z.type&&X&&(N.includes(p[d])||p[d]&&!p[d].trim()&&N.includes(p[T]))&&(z.selectors.push({value:p.slice(X,d),selectorStarts:X,selectorEnds:d}),X=void 0,z.selectorsEnd=d);const D=O(it);if(!R&&p[d])if(q(p,d,z,it,_)){z.type&&null!==z.start&&("rule"===z.type&&et&&et.propertyStarts&&(et.propertyEnds=d,et.property=p.slice(et.propertyStarts,d),et.end||(et.end=d),rt(et),at()),pt(z,d),j()),gt("tag",d),_&&(_=!1);const t="?![-/";let e="",a=!1;if(T)for(let r=T;r<F&&(!a&&p[r]&&p[r].trim()&&p[r].toUpperCase()!==p[r].toLowerCase()&&(a=!0),!a||!p[r]||p[r].trim()&&(/\w/.test(p[r])||t.includes(p[r]))&&"["!==p[r]);r++)t.includes(p[r])||(e+=p[r].trim().toLowerCase());"doctype"===e?z.kind="doctype":"cdata"===e?z.kind="cdata":"xml"===e?z.kind="xml":k.has(e)&&(z.kind="inline")}else if(M(p,d,z,it))null!=z.start&&pt(z,d),gt("comment",d),"-"===p[d]?z.closing=!0:a(p,d,["<![endif]--\x3e"],{i:!0,trimBeforeMatching:!0,maxMismatches:2})&&(z.closing=!0,z.kind="only"),_&&(_=!1);else if(Q(p,d,0,0,_))null!=z.start&&pt(z,d),gt("comment",d),z.language="css",z.kind="/"===p[d]&&"/"===p[d+1]?"line":"block",z.value=p.slice(d,d+2),z.end=d+2,z.closing="*"===p[d]&&"/"===p[d+1],H=!0,z.closing&&(H=!1),R=d+2;else if("number"==typeof D&&it[D]&&"esp"===it[D].type&&it[D].openingLump&&it[D].guessedClosingLump&&it[D].guessedClosingLump.length>1&&it[D].guessedClosingLump.includes(p[d])&&it[D].guessedClosingLump.includes(p[d+1])&&!(it[D+1]&&"'\"".includes(it[D+1].value)&&p.indexOf(it[D+1].value,d)>0&&it[D].guessedClosingLump.includes(p[i(p,p.indexOf(it[D+1].value,d))]))||B(p,d,z,it,_)&&(!nt("simple")||!["'",'"'].includes(it[~-it.length].value)||U&&U.attribStarts&&!U.attribEnds)){const t=w(p,d,it);if(!y.includes(t)){let e,a;if(it.length&&(e=$(t,it))){if("esp"===z.type){if(z.end||(z.end=d+e,z.value=p.slice(z.start,z.end),z.tail=p.slice(d,d+e),z.tailStartsAt=d,z.tailEndsAt=z.end,">"===p[d]&&"/"===p[b]&&(z.tailStartsAt=b,z.tail=p.slice(z.tailStartsAt,d+1))),R=z.tailEndsAt,Y){Array.isArray(Y.attribs)||(Y.attribs=[]),tt?(U=tt,U.attribValue.push({...z})):Y.attribs.push({...z}),z=l(Y),Y=void 0,tt=void 0,it.pop();continue}pt(z,d),j()}it.pop()}else if(it.length&&(e=$(t,it,!0)))"esp"===z.type&&(z.end||(z.end=d+(e||0),z.value=p.slice(z.start,z.end)),z.tailStartsAt||(z.tailStartsAt=d),!z.tailEndsAt&&e&&(z.tailEndsAt=z.tailStartsAt+e,z.tail=p.slice(d,d+e)),pt(z,d),j()),it.length=0;else if(U&&U.attribValue&&U.attribValue.length&&U.attribValue[~-U.attribValue.length].start&&Array.from(p.slice(U.attribValue[~-U.attribValue.length].start,d)).some(((e,r)=>t.includes(V(e))&&(c.includes(e)||!r)&&(a={char:e,idx:r})))&&"tag"===z.type&&U&&U.attribValueStartsAt&&!U.attribValueEndsAt&&U.attribValue[~-U.attribValue.length]&&"text"===U.attribValue[~-U.attribValue.length].type){z.pureHTML=!1;const e=U.attribValue[~-U.attribValue.length],r=dt("esp",e.start);a&&a.idx||(r.head=a.char,r.headStartsAt=e.start,r.headEndsAt=r.headStartsAt+1,r.tailStartsAt=d,r.tailEndsAt=d+t.length,r.tail=t,U.attribValue[~-U.attribValue.length]=r)}else nt("esp")&&it.pop(),tt&&(Array.isArray(tt.attribValue)||(tt.attribValue=[]),tt.attribValue.push(z)),it.push({type:"esp",openingLump:t,guessedClosingLump:V(t),position:d}),null!==z.start&&("tag"===z.type?(!z.tagNameStartsAt||z.tagName&&z.tagNameEndsAt||(z.tagNameEndsAt=d,z.tagName=p.slice(z.tagNameStartsAt,d),z.recognised=S(z.tagName)),Y=l(z),U.attribStarts&&!U.attribEnds&&(tt=l(U))):tt?tt&&Array.isArray(tt.attribValue)&&tt.attribValue.length&&"esp"===tt.attribValue[~-tt.attribValue.length].type&&!tt.attribValue[~-tt.attribValue.length].end&&(tt.attribValue[~-tt.attribValue.length].end=d,tt.attribValue[~-tt.attribValue.length].value=p.slice(tt.attribValue[~-tt.attribValue.length].start,d)):pt(z,d)),gt("esp",d),z.head=t,z.headStartsAt=d,z.headEndsAt=d+t.length,Y&&Y.pureHTML&&(Y.pureHTML=!1),tt&&Array.isArray(tt.attribValue)&&tt.attribValue.length&&(tt.attribValue[~-tt.attribValue.length].start===z.start?tt.attribValue.pop():"text"!==tt.attribValue[~-tt.attribValue.length].type||tt.attribValue[~-tt.attribValue.length].end||(tt.attribValue[~-tt.attribValue.length].end=d,tt.attribValue[~-tt.attribValue.length].value=p.slice(tt.attribValue[~-tt.attribValue.length].start,d)));R=d+(e||t.length)}}else!_||H||!p[d]||!p[d].trim()||"{}".includes(p[d])||z.type&&!["text"].includes(z.type)?z.type||gt("text",d):(z.type&&pt(z,d),gt("@"===p[d]?"at":"rule",d),z.left=lt,z.nested=it.some((t=>"at"===t.type)));if(R||!et||!(et.valueStarts&&!et.valueEnds&&"!"!==p[T]||et.importantStarts&&!et.importantEnds)||";"===p[T]||p[d]&&p[d].trim()&&((!";}/".includes(p[mt=d])||U&&U.attribName&&"style"===U.attribName)&&!("/;'\"><".includes(p[mt])&&U&&"style"===U.attribName&&bt(mt)))||(et.importantStarts&&!et.importantEnds&&(et.importantEnds=d,et.important=p.slice(et.importantStarts,d)),et.valueStarts&&!et.valueEnds&&(et.valueEnds=d,et.value=p.slice(et.valueStarts,d)),";"===p[d]?(et.semi=d,et.end=d+1):";"===p[T]&&(et.semi=T,et.end=et.semi+1),et.end||(et.end=d),rt(et),at()),!R&&et&&et.start&&!et.end&&";"===p[d]&&(et.semi=d,et.end=d+1,et.propertyEnds||(et.propertyEnds=d),et.propertyStarts&&et.propertyEnds&&!et.property&&(et.property=p.slice(et.propertyStarts,et.propertyEnds)),rt(et),at()),!R&&et&&et.valueEnds&&!et.importantStarts&&("!"===p[d]||f(p[d]))&&P.test(p.slice(d))&&(et.importantStarts=d),R||!et||!(et.valueStarts&&!et.valueEnds||et.propertyEnds&&!et.valueStarts&&!T)||!p[d]||p[d].trim()&&"!"!==p[d]||(et.valueStarts&&!et.valueEnds&&(et.valueEnds=d,et.value=p.slice(et.valueStarts,d)),"!"===p[d]?et.importantStarts=d:T&&"!"===p[T]||P.test(p.slice(d))?et.importantStarts=i(p,d):T&&";"===p[T]||(et.end=n(p,d+1)+1,rt(et),at()),et.start||!p[d]||p[d].trim()||rt({type:"text",start:d,end:null,value:null})),!R&&et&&et.colon&&!et.valueStarts&&p[d]&&p[d].trim())if(";}'\"".includes(p[d])&&bt(d)){let t;";"===p[d]&&(et.semi=d),et.end||(et.end=et.semi?et.semi+1:n(p,d)+1,t=et.end),rt(et),at(),t&&t<d&&rt({type:"text",start:t,end:d,value:p.slice(t,d)})}else et.valueStarts=d;if(R||"rule"!==z.type||!p[d]||!p[d].trim()||"{}".includes(p[d])||X||z.openingCurlyAt||(",".includes(p[d])?z.selectorsEnd=d+1:(X=d,null===z.selectorsStart&&(z.selectorsStart=d))),!(!R&&et&&et.propertyStarts&&et.propertyStarts<d)||et.propertyEnds||p[d]&&p[d].trim()&&(L.test(p[d])||":"!==p[d]&&T&&":/".includes(p[T]))||"/"===p[d]&&"/"===p[d-1]||(et.propertyEnds=d,et.property=p.slice(et.propertyStarts,d),et.valueStarts&&(et.end=d),("};".includes(p[d])||p[d]&&!p[d].trim()&&":"!==p[T])&&(";"===p[d]&&(et.semi=d),et.end||(et.end=et.semi?et.semi+1:d),rt(et),at())),!R&&et&&et.propertyEnds&&!et.valueStarts&&":"===p[d]&&(et.colon=d),!R&&"rule"===z.type&&p[d]&&p[d].trim()&&!"{};".includes(p[d])&&z.selectorsEnd&&z.openingCurlyAt&&!et.propertyStarts&&(Array.isArray(z.properties)&&z.properties.length&&z.properties[~-z.properties.length].start&&!z.properties[~-z.properties.length].end&&(z.properties[~-z.properties.length].end=d,z.properties[~-z.properties.length].value=p.slice(z.properties[~-z.properties.length].start,d)),ct(d)),R||!U||"style"!==U.attribName||!U.attribOpeningQuoteAt||U.attribClosingQuoteAt||et.propertyStarts||!p[d]||!p[d].trim()||"'\";".includes(p[d])||nt("block")||("/"===p[d]&&"*"===p[T]?(G({type:"comment",start:d,end:T+1,value:p.slice(d,T+1),closing:!1,kind:"block",language:"css"}),it.push({type:"block",value:p.slice(d,T+1),position:d}),R=T+1):"*"===p[d]&&"/"===p[T]?st(d):(Array.isArray(U.attribValue)&&U.attribValue.length&&!U.attribValue[~-U.attribValue.length].end&&(U.attribValue[~-U.attribValue.length].end=d,U.attribValue[~-U.attribValue.length].value=p.slice(U.attribValue[~-U.attribValue.length].start,d)),ct(d))),"comment"===z.type&&["only","not"].includes(z.kind),!R)if("tag"!==z.type||it.length||">"!==p[d])if("comment"===z.type&&"html"===z.language&&!it.length&&"simple"===z.kind&&("<"===p[z.start]&&"-"===p[d]&&(e(p,d,"!-",{trimBeforeMatching:!0})||r(p,d,"!-",{trimBeforeMatching:!0})&&"-"!==p[d+1])||"-"===p[z.start]&&">"===p[d]&&e(p,d,"--",{trimBeforeMatching:!0,maxMismatches:1})))"-"===p[d]&&(t(p,d,["[if","(if","{if"],{i:!0,trimBeforeMatching:!0})||t(p,d,["if"],{i:!0,trimBeforeMatching:!0})&&(v(p,d,"]",">")||p.includes("mso",d)&&!p.slice(d,p.indexOf("mso")).includes("<")&&!p.slice(d,p.indexOf("mso")).includes(">")))?z.kind="only":"-"!==p[z.start]&&a(p,d,["-<![endif"],{i:!0,trimBeforeMatching:!0,maxMismatches:2})?(z.kind="not",z.closing=!0):"simple"!==z.kind||"html"!==z.language||z.closing||">"!==p[T]?"html"===z.language&&(z.end=d+1,"!"===p[b]&&"-"===p[T]&&(z.end=T+1),z.value=p.slice(z.start,z.end)):(z.end=T+1,z.kind="simplet",z.closing=null);else if("comment"!==z.type||"html"!==z.language||">"!==p[d]||it.length&&"<"!==p[T]){if("comment"===z.type&&"css"===z.language&&"*"===p[d]&&"/"===p[d+1])z.end=d+1,z.value=p.slice(z.start,z.end);else if("esp"===z.type&&null===z.end&&"string"==typeof z.head&&"string"==typeof z.tail&&z.tail.includes(p[d])){let t="";for(let e=d;e<F&&g.includes(p[e]);e++)t+=p[e];if(t.length>z.head.length){const e=z.head[0];if(t.endsWith(z.head))z.end=d+t.length-z.head.length,z.value=p.slice(z.start,z.end),R=z.end;else if(t.startsWith(z.tail))z.end=d+z.tail.length,z.value=p.slice(z.start,z.end),R=z.end;else if(!z.tail.includes(e)&&t.includes(e)||t.endsWith(z.head)||t.startsWith(z.tail)){const a=t.slice(0,t.indexOf(e)),r=t.slice(t.indexOf(e));a.length&&r.length&&z.tail.split("").every((t=>a.includes(t)))&&(z.end=d+a.length,z.value=p.slice(z.start,z.end),R=z.end)}else z.end=d+t.length,z.value=p.slice(z.start,z.end),R=z.end}else z.end=d+t.length,z.value=p.slice(z.start,z.end),nt("esp")&&it.pop(),R=z.end}}else Array.isArray(it)&&it.length&&"["===it[~-it.length].value&&it.pop(),!["simplet","not"].includes(z.kind)&&t(p,d,["\x3c!--\x3e","\x3c!----\x3e"],{trimBeforeMatching:!0,maxMismatches:1,lastMustMatch:!0})?z.kind="not":(z.end=d+1,z.value=p.slice(z.start,z.end));else z.end=d+1,z.value=p.slice(z.start,z.end);if(R||"tag"!==z.type||!z.tagNameStartsAt||z.tagNameEndsAt||p[d]&&/[.\-_a-z0-9\u00B7\u00C0-\uFFFD]/i.test(p[d])||(z.tagNameEndsAt=d,z.tagName=p.slice(z.tagNameStartsAt,d).toLowerCase(),"xml"===z.tagName&&z.closing&&!z.kind&&(z.kind="xml"),C.includes(z.tagName)&&(z.void=!0),z.recognised=S(z.tagName)),R||"tag"!==z.type||z.tagNameStartsAt||null==z.start||!(z.start<d||"<"!==p[z.start])||("/"===p[d]?z.closing=!0:f(p[d])&&(z.tagNameStartsAt=d,z.closing||(z.closing=!1))),!R&&"tag"===z.type&&"cdata"!==z.kind&&U.attribNameStartsAt&&d>U.attribNameStartsAt&&null===U.attribNameEndsAt&&!o(p[d])&&(U.attribNameEndsAt=d,U.attribName=p.slice(U.attribNameStartsAt,d),U.attribNameRecognised=u.has(U.attribName),U.attribName.startsWith("mc:")&&(z.pureHTML=!1),p[d]&&!p[d].trim()&&"="===p[T]||(p[d]&&!p[d].trim()||">"===p[d]||"/"===p[d]&&">"===p[T])&&("'\"".includes(p[T])||(U.attribEnds=d,z.attribs.push(l(U)),Z()))),!R&&p[d]&&"tag"===z.type&&"cdata"!==z.kind&&z.tagNameEndsAt&&d>z.tagNameEndsAt&&null===U.attribStarts&&o(p[d])&&(U.attribStarts=d,U.attribLeft=lt,U.attribNameStartsAt=d),R||"rule"!==z.type||("{"!==p[d]||z.openingCurlyAt?"}"===p[d]&&z.openingCurlyAt&&!z.closingCurlyAt&&(z.closingCurlyAt=d,z.end=d+1,z.value=p.slice(z.start,z.end),Array.isArray(z.properties)&&z.properties.length&&z.properties[~-z.properties.length].start&&!z.properties[~-z.properties.length].end&&(z.properties[~-z.properties.length].end=d,z.properties[~-z.properties.length].value=p.slice(z.properties[~-z.properties.length].start,d)),ot(z),nt("at")&&it[~-it.length].token.rules.push(z),j()):z.openingCurlyAt=d),!R&&U.attribName&&Array.isArray(U.attribValue)&&U.attribValue.length&&!U.attribValue[~-U.attribValue.length].end&&"*"===p[d]&&"/"===p[T]&&st(d),(!R&&U&&U.attribValueStartsAt&&!U.attribValueEndsAt&&!et.propertyStarts&&d>=U.attribValueStartsAt&&Array.isArray(U.attribValue)&&(!U.attribValue.length||U.attribValue[~-U.attribValue.length].end&&U.attribValue[~-U.attribValue.length].end<=d)||!R&&"rule"===z.type&&z.openingCurlyAt&&!z.closingCurlyAt&&!et.propertyStarts)&&(p[d]&&!p[d].trim()||nt("block"))&&(U.attribName?U.attribValue.push({type:"text",start:d,end:null,value:null}):"rule"!==z.type||Array.isArray(z.properties)&&z.properties.length&&!z.properties[~-z.properties.length].end||z.properties.push({type:"text",start:d,end:null,value:null})),!R&&"tag"===z.type&&U.attribValueStartsAt&&d>=U.attribValueStartsAt&&null===U.attribValueEndsAt)if(x.includes(p[d]))it.some((t=>"esp"===t.type))||p[d]&&p.includes(">",d)&&!s(p,U.attribOpeningQuoteAt||U.attribValueStartsAt,d)?Array.isArray(U.attribValue)&&U.attribValue.length&&"text"===U.attribValue[~-U.attribValue.length].type||et.propertyStarts||U.attribValue.push({type:"text",start:d,end:null,value:null}):(U.attribClosingQuoteAt=d,U.attribValueEndsAt=d,U.attribValueStartsAt&&(U.attribValueRaw=p.slice(U.attribValueStartsAt,d)),U.attribEnds=d+1,et.propertyStarts&&(U.attribValue.push(l(et)),at()),Array.isArray(U.attribValue)&&U.attribValue.length&&!U.attribValue[~-U.attribValue.length].end&&(U.attribValue[~-U.attribValue.length].property||(U.attribValue[~-U.attribValue.length].end=d,U.attribValue[~-U.attribValue.length].value=p.slice(U.attribValue[~-U.attribValue.length].start,d))),p[U.attribOpeningQuoteAt]!==p[d]&&(it.pop(),it.pop()),U.attribValue[~-U.attribValue.length]&&!U.attribValue[~-U.attribValue.length].end&&(U.attribValue[~-U.attribValue.length].end=d),z.attribs.push(l(U)),Z());else if(null===U.attribOpeningQuoteAt&&(p[d]&&!p[d].trim()||["/",">"].includes(p[d])||g.includes(p[d])&&g.includes(p[d+1])))U.attribValueEndsAt=d,U.attribValueRaw=p.slice(U.attribValueStartsAt,d),Array.isArray(U.attribValue)&&U.attribValue.length&&!U.attribValue[~-U.attribValue.length].end&&(U.attribValue[~-U.attribValue.length].end=d,U.attribValue[~-U.attribValue.length].value=p.slice(U.attribValue[~-U.attribValue.length].start,U.attribValue[~-U.attribValue.length].end)),U.attribEnds=d,z.attribs.push(l(U)),Z(),it.pop(),">"===p[d]&&(z.end=d+1,z.value=p.slice(z.start,z.end));else if("="!==p[d]||null===b||!T||!("'\"".includes(p[T])||p[~-d]&&f(p[~-d]))||U&&U.attribOpeningQuoteAt&&(/\//.test(p.slice(U.attribOpeningQuoteAt+1,d))||/mailto:/.test(p.slice(U.attribOpeningQuoteAt+1,d))||/\w\?\w/.test(p.slice(U.attribOpeningQuoteAt+1,d))))!U||"style"===U.attribName||!U.attribStarts||U.attribEnds||et.propertyStarts||Array.isArray(U.attribValue)&&U.attribValue.length&&!(U.attribValue[~-U.attribValue.length].end&&U.attribValue[~-U.attribValue.length].end<=d)||U.attribValue.push({type:"text",start:d,end:null,value:null});else{let t,e;for(let a=b;a>=U.attribValueStartsAt;a--)t||!p[a]||p[a].trim()||(t=!0,e&&p.slice(a,e)),t&&p[a]&&p[a].trim()&&(t=!1,e||(e=a+1));if(e){U.attribValueEndsAt=e,U.attribValueStartsAt&&(U.attribValueRaw=p.slice(U.attribValueStartsAt,e),Array.isArray(U.attribValue)&&U.attribValue.length&&!U.attribValue[~-U.attribValue.length].end&&(U.attribValue[~-U.attribValue.length].end=U.attribValueEndsAt,U.attribValue[~-U.attribValue.length].value=p.slice(U.attribValue[~-U.attribValue.length].start,U.attribValueEndsAt))),U.attribEnds=e,p[U.attribOpeningQuoteAt]!==p[d]&&it.pop(),z.attribs.push(l(U)),Z(),d=~-e;continue}if(U.attribOpeningQuoteAt&&("'\"".includes(p[T])||u.has(p.slice(U.attribOpeningQuoteAt+1,d).trim()))){d=U.attribOpeningQuoteAt,U.attribEnds=U.attribOpeningQuoteAt+1,U.attribValueStartsAt=null,it.pop(),z.attribs.push(l(U)),Z();continue}}else"esp"===z.type&&tt&&Y&&tt.attribOpeningQuoteAt&&tt.attribValueStartsAt&&"'\"".includes(p[d])&&p[tt.attribOpeningQuoteAt]===p[d]&&s(p,tt.attribOpeningQuoteAt,d)&&(z.end=d,z.value=p.slice(z.start,d),tt&&!Array.isArray(tt.attribValue)&&(tt.attribValue=[]),tt.attribValue.push(z),tt.attribValueEndsAt=d,tt.attribValueRaw=p.slice(tt.attribValueStartsAt,d),tt.attribClosingQuoteAt=d,tt.attribEnds=d+1,z=l(Y),z.attribs.push(tt),tt=void 0,Y=void 0,it.pop(),it.pop(),it.pop());if(!R&&"tag"===z.type&&!U.attribValueStartsAt&&U.attribNameEndsAt&&U.attribNameEndsAt<=d&&p[d]&&p[d].trim())if("="!==p[d]||x.includes(p[T])||"=".includes(p[T])||g.includes(p[T])){if(x.includes(p[d])){const t=T;!(t&&x.includes(p[t])&&p[d]!==p[t]&&p.length>t+2&&p.slice(t+1).includes(p[t]))||p.indexOf(p[t],t+1)&&i(p,p.indexOf(p[t],t+1))&&p[d]===p[i(p,p.indexOf(p[t],t+1))]||Array.from(p.slice(t+1,p.indexOf(p[t]))).some((t=>`<>=${p[d]}`.includes(t)))?U.attribOpeningQuoteAt?(s(p,U.attribOpeningQuoteAt,d)&&(U.attribClosingQuoteAt=d),U.attribOpeningQuoteAt&&U.attribClosingQuoteAt&&(U.attribValueRaw=U.attribOpeningQuoteAt<~-U.attribClosingQuoteAt?p.slice(U.attribOpeningQuoteAt+1,U.attribClosingQuoteAt):"",U.attribEnds=d+1,z.attribs.push(l(U)),Z())):(U.attribOpeningQuoteAt=d,!p[d+1]||p[d+1]===p[d]&&bt(d+1)||(U.attribValueStartsAt=d+1)):it.pop()}}else{const t=x.split("").map((t=>p.indexOf(t,T))).filter((t=>t>0)).length?Math.min(...x.split("").map((t=>p.indexOf(t,T))).filter((t=>t>0))):void 0;T&&p.slice(T).includes("=")&&u.has(p.slice(T,T+p.slice(T).indexOf("=")).trim().toLowerCase())?(U.attribEnds=d+1,z.attribs.push({...U}),Z()):t&&!p.slice(T,t).includes("=")&&p.includes(p[t],t+1)&&!Array.from(p.slice(t+1,p.indexOf(p[t],t+1))).some((t=>"<>=".includes(t)))||(U.attribValueStartsAt=T,it.push({type:"simple",value:null,position:U.attribValueStartsAt}))}if(!R&&">"===p[d]&&"%"!==p[d-1]&&"tag"===z.type&&U.attribStarts&&!U.attribEnds){let t=!1;if(p[d+1])for(let e=d+1;e<F;e++){if(U.attribOpeningQuoteAt&&p[e]===p[U.attribOpeningQuoteAt]){e!==d+1&&"="!==p[~-e]&&(t=!0);break}if(">"===p[e])break;if("<"===p[e]){t=!0,it.pop();break}if(!p[e+1]){t=!0;break}}else t=!0;t&&(z.end=d+1,z.value=p.slice(z.start,z.end),U.attribValueStartsAt&&d&&U.attribValueStartsAt<d&&p.slice(U.attribValueStartsAt,d).trim()?(U.attribValueEndsAt=d,U.attribValueRaw=p.slice(U.attribValueStartsAt,d),Array.isArray(U.attribValue)&&U.attribValue.length&&!U.attribValue[~-U.attribValue.length].end&&(U.attribValue[~-U.attribValue.length].end=d,U.attribValue[~-U.attribValue.length].value=p.slice(U.attribValue[~-U.attribValue.length].start,d))):U.attribValueStartsAt=null,null===U.attribEnds&&(U.attribEnds=d),U&&(z.attribs.push(l(U)),Z()))}p[d]&&h.charCb&&(ht={type:z.type,chr:p[d],i:d},h.charCb&&(I.push(ht),I.length>h.charCbLookahead&&ut(I,h.charCb,h.charCbLookahead))),p[d]||null===z.start||(z.end=d,z.value=p.slice(z.start,z.end),U&&U.attribName&&(U.attribEnds||(U.attribEnds=d),z.attribs.push({...U}),Z()),z&&Array.isArray(z.properties)&&z.properties.length&&!z.properties[~-z.properties.length].end&&(z.properties[~-z.properties.length].end=d,z.properties[~-z.properties.length].start&&!z.properties[~-z.properties.length].value&&(z.properties[~-z.properties.length].value=p.slice(z.properties[~-z.properties.length].start,d))),et&&et.propertyStarts&&(et.end||(et.end=d),rt(et),at()),ot(z)),p[d]&&p[d].trim()&&(lt=d)}var ht,mt;if(I.length)for(let t=0,e=I.length;t<e;t++)ut(I,h.charCb,h.charCbLookahead);if(D.length)for(let t=0,e=D.length;t<e;t++)ut(D,h.tagCb,h.tagCbLookahead);return{timeTakenInMilliseconds:Date.now()-b}}const _={matchLayerLast:$};export{T as defaults,R as tokenizer,_ as util,W as version};
